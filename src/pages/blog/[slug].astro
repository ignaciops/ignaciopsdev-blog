---
// src/pages/blog/[slug].astro
import { getCollection, getEntry } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';
import KeystaticImage from '../../components/mdx/KeystaticImage.astro';
import YouTube from '../../components/mdx/YouTube.astro';
import Callout from '../../components/mdx/Callout.astro';
import GalleryGrid from '../../components/mdx/KeystaticGalleryGrid.astro';
import GalleryLightbox from '../../components/mdx/KeystaticGalleryLightbox.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

// Fetch the specific post
const post = await getEntry('posts', slug!);

if (!post) {
  return Astro.redirect('/404');
}

// Get all posts sorted for prev/next navigation
const allPosts = (await getCollection('posts')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const currentIndex = allPosts.findIndex(p => p.slug === slug);
const prev = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const next = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

const { Content, headings } = await post.render();
---

<PostLayout
  frontmatter={post.data}
  headings={headings}
  body={post.body}
  prev={prev}
  next={next}
>
  <Content components={{ YouTube, KeystaticImage, Callout, GalleryGrid, GalleryLightbox }} />
</PostLayout>
