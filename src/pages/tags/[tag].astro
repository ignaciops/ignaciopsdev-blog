---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const allTags = new Set<string>();
  posts.forEach(post => {
    if (post.data.tags) {
        post.data.tags.forEach(tag => allTags.add(tag));
    }
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const posts = (await getCollection('posts', ({ data }) =>
    data.tags ? data.tags.includes(tag!) : false
)).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<BaseLayout title={`Posts tagged with "${tag}"`}>
    <div class="max-w-3xl mx-auto">
        <h1 data-testid="tag-page-title" class="font-sans font-bold text-4xl mb-8 text-gray-900 dark:text-white">
            Posts etiquetados con <span class="text-brand-600 dark:text-brand-400">#{tag}</span>
        </h1>
        <div data-testid="tag-posts-list" class="space-y-12">
            {posts.map(post => (
                <PostCard
                    title={post.data.title}
                    slug={post.slug}
                    date={post.data.date}
                    summary={post.data.summary || ''}
                    tags={post.data.tags}
                    readingText={post.body}
                />
            ))}
        </div>
    </div>
</BaseLayout>
